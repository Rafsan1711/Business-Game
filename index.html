<!DOCTYPE html>
<html lang="bn" class="bg-gray-900 text-white">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Business Empire ‚Äî Stocks & Crypto (Single File)</title>
  <link rel="icon" type="image/png" href="favicon.png">
  <script src="https://cdn.tailwindcss.com"></script>

  <!-- Chart.js CDN -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

  <style>
    /* === original styles preserved from your provided file === */
    body { font-family: 'Balsamiq Sans', sans-serif; }
    @font-face {
      font-family: 'Balsamiq Sans';
      src: url('fonts/BalsamiqSans-Regular.ttf') format('truetype');
    }
    .bgmusic-settings { box-shadow: 0 2px 12px #222b; }

    .switch { position: relative; display: inline-block; width: 54px; height: 28px; }
    .switch input {display:none;}
    .slider {
      position: absolute;
      cursor: pointer;
      top: 0; left: 0; right: 0; bottom: 0;
      background-color: #23272f;
      transition: .4s;
      border-radius: 34px;
      border: 2px solid #4ade80;
    }
    .slider:before {
      position: absolute;
      content: "";
      height: 22px; width: 22px;
      left: 2px; bottom: 2px;
      background-color: #4ade80;
      transition: .4s;
      border-radius: 50%;
      box-shadow: 0 2px 6px #000a;
    }
    input:checked + .slider { background-color: #4ade80; }
    input:checked + .slider:before {
      transform: translateX(26px);
      background: #23272f;
      border: 2px solid #4ade80;
    }
    input:not(:checked) + .slider:before {
      background: #4ade80;
      border: 2px solid #23272f;
    }

    .volume-slider {
      appearance: none;
      background: linear-gradient(90deg,#4a90e2 0%,#4ade80 100%);
      height: 6px;
      border-radius: 6px;
      outline: none;
      margin: 0 0 12px 0;
      transition: background 0.3s;
    }

    .volume-slider::-webkit-slider-thumb {
      appearance: none;
      width: 24px; height: 24px;
      background: #fff;
      border: 3px solid #4ade80;
      border-radius: 50%;
      cursor: pointer;
      box-shadow: 0 2px 6px #60a5fa99;
      transition: background 0.2s, border 0.2s;
    }

    /* board-related styles (preserved) */
    .download-btn { background: linear-gradient(90deg, #4a90e2 0%, #60a5fa 100%); color: #fff; font-size: 1.15rem; font-weight: 700; padding: 14px 38px; border-radius: 10px; border: none; box-shadow: 0 2px 8px #2225; cursor: pointer; transition: background 0.2s, transform 0.2s; outline: none; margin-top: 6px; margin-bottom: 6px; font-family: 'Balsamiq Sans', sans-serif; display: inline-flex; align-items: center;}
    .download-btn:hover { background: linear-gradient(90deg, #2563eb 0%, #38bdf8 100%); transform: translateY(-2px) scale(1.04); }
    .download-section h3 { color: #4ade80; font-family: 'Balsamiq Sans', sans-serif; text-shadow: 0 1px 7px #333; }

    .dot { width: 16px; height: 16px; background: white; border-radius: 50%; margin: auto; }
    .line { background-color: #444; cursor: pointer; transition: background 0.3s, box-shadow 0.3s; }
    .line.horizontal { height: 7px; margin: auto; }
    .line.vertical { width: 7px; margin: auto; }
    .line.active { cursor: default; }
    .box { background: #2a2a2a; display: flex; align-items: center; justify-content: center; font-weight: bold; font-size: 1.5rem; color: white; user-select: none; transition: background 0.3s; }
    .player-1 { background: #4a90e2; }
    .player-2 { background: #e94e77; }
    .player-3 { background: #f5a623; }
    .player-4 { background: #7ed321; }
    #status { font-size: 1.3rem; font-weight: bold; margin: 1rem 0; text-align: center; padding: 0.7rem 1.4rem; border-radius: 8px; }
    .blue-turn { background: #4a90e2; box-shadow: 0 0 12px #4a90e2; font-family: 'Balsamiq Sans', sans-serif;}
    .red-turn { background: #e94e77; box-shadow: 0 0 12px #e94e77; font-family: 'Balsamiq Sans', sans-serif;}
    .orange-turn { background: #f5a623; box-shadow: 0 0 12px #f5a623; font-family: 'Balsamiq Sans', sans-serif;}
    .green-turn { background: #7ed321; box-shadow: 0 0 12px #7ed321; font-family: 'Balsamiq Sans', sans-serif;}
    #winner-message { font-size: 1.9rem; font-weight: 800; text-align: center; margin: 1.5rem 0; color: #00ff00; text-shadow: 0 0 6px #00ff00; font-family: 'Balsamiq Sans', sans-serif;}
    #restart { display: none; margin: 0 auto 2rem auto; padding: 12px 30px; font-size: 1.2rem; font-weight: 700; background: #555; border: none; border-radius: 10px; color: white; cursor: pointer; transition: background 0.3s; font-family: 'Balsamiq Sans', sans-serif;}
    #restart:hover { background: #777;}
    #modal { position: fixed; inset: 0; background: rgba(0,0,0,0.75); display: none; align-items: center; justify-content: center; z-index: 1000; }
    #modal.active { display: flex; }
    #modal-content { background: #111; padding: 2rem; border-radius: 10px; max-width: 400px; width: 90%; color: white; text-align: center; }
    .mode-btn { transition: background 0.3s, color 0.3s; }
    .mode-btn.active { background: #4ade80; color: black;}
    .loader { border: 5px solid #444; border-top: 5px solid #00ff00; border-radius: 50%; width: 50px; height: 50px; animation: spin 1.5s linear infinite; margin: 0 auto 1rem auto; }
    @keyframes spin { 0% {transform: rotate(0deg);} 100% {transform: rotate(360deg);} }
    .bottom-nav { border-top: 1px solid #555; display: flex; justify-content: space-around; background: #121212; }
    .bottom-nav button { flex-grow: 1; padding: 1rem 0; font-size: 1.1rem; color: #bbb; background: none; border: none; cursor: pointer; transition: background 0.3s;}
    .bottom-nav button.active, .bottom-nav button:hover { background: #222; color: white; }
    #friend-search { width: 100%; max-width: 400px; margin: 0 auto 1rem auto; padding: 10px 15px; font-size: 1.1rem; border-radius: 12px; border: none; outline: none; background: #222; color: white; box-shadow: 0 0 10px #4a90e2; transition: box-shadow 0.3s; }
    #friend-search:focus { box-shadow: 0 0 15px #60a5fa; }
    #friends-list, #search-results { max-width: 400px; margin: 0 auto; margin-bottom: 1rem; }
    .friend-item, .search-item { display: flex; align-items: center; background: #1e1e2f; padding: 10px 15px; border-radius: 12px; margin-bottom: 10px; transition: background 0.3s; }
    .friend-item:hover, .search-item:hover { background: #33334d; }
    .friend-pic, .search-pic { width: 48px; height: 48px; border-radius: 50%; margin-right: 12px; object-fit: cover; border: 2px solid #4a90e2; }
    .friend-info, .search-info { flex-grow: 1; }
    .friend-name, .search-name { font-weight: 700; font-size: 1.1rem; margin-bottom: 2px; }
    .friend-rating, .search-rating { font-size: 0.9rem; color: #60a5fa; }
    .add-btn { width: 36px; height: 36px; background: #4ade80; border-radius: 8px; color: black; font-weight: 900; font-size: 1.8rem; line-height: 36px; text-align: center; cursor: pointer; user-select: none; transition: background 0.3s; }
    .add-btn:hover { background: #22c55e;}
    .remove-btn { width: 36px; height: 36px; background: #ef4444; border-radius: 8px; color: white; font-weight: 900; font-size: 1.6rem; line-height: 36px; text-align: center; cursor: pointer; user-select: none; transition: background 0.3s; }
    .remove-btn:hover { background: #b91c1c; }
    #notification-bell { position: fixed; top: 12px; right: 20px; font-size: 1.8rem; cursor: pointer; color: #60a5fa; z-index: 1100; user-select: none; transition: color 0.3s;}
    #notification-bell:hover { color: #38bdf8;}
    #notification-modal { position: fixed; inset: 0; background: rgba(0,0,0,0.85); display: none; align-items: center; justify-content: center; z-index: 1200; }
    #notification-modal.active { display: flex;}
    #notification-content { background: #111; padding: 1.5rem 2rem; border-radius: 10px; max-width: 420px; width: 90%; color: white; max-height: 70vh; overflow-y: auto;}
    .notification-item { background: #222; padding: 10px 15px; border-radius: 8px; margin-bottom: 12px; display: flex; justify-content: space-between; align-items: center;}
    .notification-text { font-weight: 600;}
    .notif-btn { cursor: pointer; font-size: 1.4rem; margin-left: 12px; user-select: none;}
    .notif-btn.accept { color: #22c55e;}
    .notif-btn.decline { color: #ef4444;}
    /* Responsive Board */
    #game-board .board-grid { margin: 0 auto; display: grid; background: #1e1e1e; border-radius: 16px; box-shadow: 0 0 8px #222; gap: 0px; }
    @media (max-width: 600px) {
      #game-board .board-grid { max-width: 95vw; }
      .box, .dot, .line.horizontal, .line.vertical { font-size: 1.1rem !important; }
    }
    /* Friend online status badge */
    .online-badge { display: inline-block; width: 11px; height: 11px; border-radius: 50%; background: #22c55e; margin-left: 8px; border: 2px solid #222; }
    .offline-badge { display: inline-block; width: 11px; height: 11px; border-radius: 50%; background: #d1d5db; margin-left: 8px; border: 2px solid #222; }
    /* Challenge modal */
    #challenge-modal { position: fixed; inset: 0; background: rgba(0,0,0,0.85); display: none; align-items: center; justify-content: center; z-index: 9999;}
    #challenge-modal.active { display: flex; }
    #challenge-content { background: #111; padding: 2rem; border-radius: 16px; max-width: 400px; width: 90%; color: white; text-align: center;}
    .challenge-btn { margin: 0 8px; padding: 10px 24px; border-radius: 8px; font-weight: bold; font-size: 1rem; border: none; cursor: pointer; }
    .challenge-accept { background: #22c55e; color: #fff;}
    .challenge-decline { background: #ef4444; color: #fff;}
    .challenge-accept:hover { background: #16a34a;}
    .challenge-decline:hover { background: #b91c1c;}
    /* Scoreboard Modal */
    #scoreboard-modal { display: none; position: fixed; inset: 0; background: rgba(0,0,0,0.88); z-index: 2000; align-items: center; justify-content: center; }
    #scoreboard-modal.active { display: flex; }
    #scoreboard-list .rank-box { display: flex; align-items:center; justify-content:space-between; background: #222; border-radius: 10px; padding: 10px 16px; margin-bottom: 10px; font-size: 1.12rem; font-weight: bold; }
    .rank-box .player-name { border-radius: 8px; padding: 4px 12px; font-weight: bold; font-size:1.06rem; display:inline-block; }
    .rank-1   { color: #fff; }
    .rank-2   { color: #eee; }
    .rank-3   { color: #ddd; }
    .rank-4   { color: #ccc; }
    .player-blue   { background: #4a90e2; color: #fff;}
    .player-red    { background: #e94e77; color: #fff;}
    .player-orange { background: #f5a623; color: #181818;}
    .player-green  { background: #7ed321; color: #181818;}
    .bot-play-button { display: inline-block; padding: 12px 28px; font-size: 1.05rem; font-weight: bold; color: white; background: #3b82f6; border: none; border-radius: 10px; text-decoration: none; transition: background 0.25s ease; margin-top: 20px; }
    .bot-play-button:hover { background: #2563eb; }

    /* === new styles for market UI (kept minimal & consistent) === */
    .market-card { background: #111827; border: 1px solid #222; border-radius: 12px; padding: 12px; margin-bottom: 12px; display:flex; align-items:center; gap:12px; }
    .market-name { font-weight:800; font-size:1.05rem; }
    .market-price { font-weight:700; font-size:1.05rem; }
    .small-muted { color:#9ca3af; font-size:0.9rem; }
    .positive { color:#4ade80; font-weight:800; }
    .negative { color:#ef4444; font-weight:800; }

    .flex-col-scroll { display:flex; flex-direction:column; gap:8px; max-height:60vh; overflow:auto; padding-right:6px; }
    .portfolio-item { display:flex; justify-content:space-between; align-items:center; gap:12px; padding:10px; background:#0f1724; border-radius:10px; border:1px solid #222; }
    .btn-small { padding:8px 12px; border-radius:8px; background:#2563eb; color:white; font-weight:700; border:none; cursor:pointer; }
    .btn-danger { background:#ef4444; color:white; }
    .pill { padding:6px 10px; border-radius:999px; background:#111827; border:1px solid #333; font-weight:700; }
    .muted { color:#9ca3af; }
    .hint { color:#94a3b8; font-size:0.95rem; }

  </style>
</head>
<body class="min-h-screen flex flex-col">

  <!-- Notification bell (kept) -->
  <div id="notification-bell" title="Friend Requests">üîî</div>

  <!-- MAIN APP LAYOUT (authentication-screen removed for simplicity; user already gave code) -->
  <div id="app" class="flex-grow flex flex-col">
    <header class="flex justify-between items-center p-4 border-b border-gray-700 relative">
      <div>
        <span id="display-username" class="font-bold text-xl">Player</span>
        <span class="text-sm muted ml-3">| Demo</span>
      </div>
      <div class="flex items-center gap-4">
        <div class="text-right">
          <div class="text-sm muted">Balance</div>
          <div id="balance" class="text-2xl font-extrabold">‡ß≥ 0</div>
        </div>
        <button onclick="openSettings()" class="px-3 py-2 rounded border border-gray-600">‚öôÔ∏è</button>
      </div>
    </header>

    <main class="flex-grow overflow-auto p-4">
      <!-- NAV / SCREEN SWITCH -->
      <div class="mb-4 flex gap-3 justify-center">
        <button id="nav-home" onclick="showScreen('home')" class="mode-btn active px-4 py-2 rounded bg-gray-800 border border-gray-700">Home</button>
        <button id="nav-stocks" onclick="showScreen('stocks')" class="mode-btn px-4 py-2 rounded border border-gray-700">Stocks</button>
        <button id="nav-crypto" onclick="showScreen('crypto')" class="mode-btn px-4 py-2 rounded border border-gray-700">Crypto</button>
        <button id="nav-portfolio" onclick="showScreen('portfolio')" class="mode-btn px-4 py-2 rounded border border-gray-700">Portfolio</button>
      </div>

      <!-- Home Screen -->
      <section id="screen-home" class="">
        <div class="max-w-4xl mx-auto">
          <h2 class="text-3xl font-bold mb-4">Home</h2>
          <div class="grid md:grid-cols-3 gap-4">
            <div class="md:col-span-2">
              <div class="market-card">
                <div>
                  <div class="small-muted">Total Net Worth</div>
                  <div id="networth" class="text-2xl font-extrabold">‡ß≥ 0</div>
                  <div class="hint">Net Worth = Balance + Market value of holdings</div>
                </div>
              </div>

              <div class="mt-4">
                <h3 class="text-xl font-bold mb-2">Recent Activities</h3>
                <div id="activity-list" class="flex-col-scroll"></div>
              </div>
            </div>

            <aside>
              <div class="market-card">
                <div style="width:100%">
                  <div class="small-muted">Quick Actions</div>
                  <div class="mt-3 flex flex-col gap-2">
                    <button class="btn-small" onclick="showScreen('stocks')">Open Stocks Market</button>
                    <button class="btn-small" onclick="showScreen('crypto')">Open Crypto Market</button>
                    <button class="btn-small" onclick="showScreen('portfolio')">View Portfolio</button>
                  </div>
                </div>
              </div>

              <div class="market-card mt-3">
                <div>
                  <div class="small-muted">Total P/L</div>
                  <div id="total-pl" class="text-xl font-bold">‡ß≥ 0</div>
                  <div class="hint mt-2">Positive values shown in green; negative in red.</div>
                </div>
              </div>
            </aside>
          </div>
        </div>
      </section>

      <!-- Stocks Screen -->
      <section id="screen-stocks" class="hidden max-w-4xl mx-auto">
        <div class="flex justify-between items-center mb-4">
          <h2 class="text-3xl font-bold">Stock Market</h2>
          <div class="text-sm muted">Last update: <span id="stocks-last-update">‚Äî</span></div>
        </div>

        <div class="grid md:grid-cols-3 gap-4">
          <div class="md:col-span-1">
            <h3 class="text-lg font-bold mb-2">Companies</h3>
            <div id="companies-list" class="flex-col-scroll"></div>
            <div class="mt-3 small-muted">Tip: Click a company to view details and buy.</div>
          </div>

          <div class="md:col-span-2">
            <div class="market-card">
              <div style="width:100%">
                <div class="flex justify-between items-start">
                  <div>
                    <div id="market-selected-name" class="market-name text-2xl">Select a company</div>
                    <div id="market-selected-symbol" class="small-muted">‚Äî</div>
                  </div>
                  <div class="text-right">
                    <div class="small-muted">Current Price</div>
                    <div id="market-selected-price" class="market-price text-2xl">‡ß≥ ‚Äî</div>
                    <div id="market-selected-change" class="small-muted">‚Äî</div>
                  </div>
                </div>

                <div class="mt-4">
                  <canvas id="market-chart" height="180"></canvas>
                </div>

                <div class="mt-4 flex gap-3 items-center">
                  <div>
                    <label class="small-muted block mb-1">Quantity</label>
                    <input id="buy-qty" type="number" min="1" value="1" class="px-3 py-2 rounded bg-gray-900 border border-gray-700 w-32" />
                  </div>
                  <div>
                    <button id="buy-btn" class="btn-small" onclick="buySelected()">Buy</button>
                  </div>
                  <div class="ml-auto text-right small-muted">
                    <div>Cash: <span id="header-balance">‡ß≥ 0</span></div>
                    <div id="est-cost" class="hint">Est. cost: ‡ß≥ 0</div>
                  </div>
                </div>

              </div>
            </div>
          </div>
        </div>
      </section>

      <!-- Crypto Screen -->
      <section id="screen-crypto" class="hidden max-w-4xl mx-auto">
        <div class="flex justify-between items-center mb-4">
          <h2 class="text-3xl font-bold">Crypto Market</h2>
          <div class="text-sm muted">Last update: <span id="crypto-last-update">‚Äî</span></div>
        </div>

        <div class="grid md:grid-cols-3 gap-4">
          <div class="md:col-span-1">
            <h3 class="text-lg font-bold mb-2">Coins</h3>
            <div id="coins-list" class="flex-col-scroll"></div>
            <div class="mt-3 small-muted">Tip: Crypto behaves similarly to stocks here.</div>
          </div>

          <div class="md:col-span-2">
            <div class="market-card">
              <div style="width:100%">
                <div class="flex justify-between items-start">
                  <div>
                    <div id="coin-selected-name" class="market-name text-2xl">Select a coin</div>
                    <div id="coin-selected-symbol" class="small-muted">‚Äî</div>
                  </div>
                  <div class="text-right">
                    <div class="small-muted">Current Price</div>
                    <div id="coin-selected-price" class="market-price text-2xl">‡ß≥ ‚Äî</div>
                    <div id="coin-selected-change" class="small-muted">‚Äî</div>
                  </div>
                </div>

                <div class="mt-4">
                  <canvas id="coin-chart" height="180"></canvas>
                </div>

                <div class="mt-4 flex gap-3 items-center">
                  <div>
                    <label class="small-muted block mb-1">Quantity</label>
                    <input id="buy-qty-coin" type="number" min="1" value="1" class="px-3 py-2 rounded bg-gray-900 border border-gray-700 w-32" />
                  </div>
                  <div>
                    <button id="buy-coin-btn" class="btn-small" onclick="buySelectedCoin()">Buy</button>
                  </div>
                  <div class="ml-auto text-right small-muted">
                    <div>Cash: <span id="header-balance-coin">‡ß≥ 0</span></div>
                    <div id="est-cost-coin" class="hint">Est. cost: ‡ß≥ 0</div>
                  </div>
                </div>

              </div>
            </div>
          </div>
        </div>
      </section>

      <!-- Portfolio Screen -->
      <section id="screen-portfolio" class="hidden max-w-4xl mx-auto">
        <h2 class="text-3xl font-bold mb-4">Portfolio</h2>

        <div class="grid md:grid-cols-2 gap-4">
          <div>
            <h3 class="text-xl font-bold mb-2">Holdings</h3>
            <div id="portfolio-list" class="flex-col-scroll"></div>
          </div>

          <div>
            <h3 class="text-xl font-bold mb-2">Transactions</h3>
            <div id="transactions-list" class="flex-col-scroll"></div>
          </div>
        </div>
      </section>

      <!-- Settings Modal (simple drawer) -->
      <div id="settings-panel" style="display:none; position:fixed; right:12px; top:80px; width:320px; z-index:1400;">
        <div class="bg-gray-900 border border-gray-700 rounded-lg p-4">
          <div class="flex justify-between items-center mb-3">
            <div class="text-lg font-bold">Settings</div>
            <button onclick="closeSettings()" class="px-2 py-1 rounded border">‚úñ</button>
          </div>

          <div class="mb-3">
            <label class="small-muted">Starting Balance</label>
            <input id="setting-start-balance" type="number" min="0" value="100000" class="px-3 py-2 rounded bg-gray-900 border border-gray-700 w-full" />
            <div class="hint mt-1">Change and press Apply to reset game with new starting balance.</div>
            <div class="mt-2 flex gap-2">
              <button class="btn-small" onclick="applySettings()">Apply</button>
              <button class="btn-small btn-danger" onclick="resetGame()">Reset Game</button>
            </div>
          </div>

          <div class="mb-3">
            <label class="small-muted">Simulation Speed</label>
            <div class="flex items-center gap-2 mt-2">
              <select id="setting-speed" class="px-3 py-2 rounded bg-gray-900 border border-gray-700 w-full">
                <option value="60000">Real (1 min)</option>
                <option value="15000">Fast (15s) ‚Äî Demo</option>
                <option value="5000">Faster (5s) ‚Äî Dev</option>
              </select>
            </div>
            <div class="hint mt-1">How often prices update.</div>
          </div>

        </div>
      </div>

    </main>

    <!-- bottom nav (kept for familiarity) -->
    <nav class="bottom-nav">
      <button onclick="showScreen('home')" class="active">üè†<br><small>Home</small></button>
      <button onclick="showScreen('stocks')">üìà<br><small>Stocks</small></button>
      <button onclick="showScreen('crypto')">‚Çø<br><small>Crypto</small></button>
      <button onclick="showScreen('portfolio')">üíº<br><small>Portfolio</small></button>
    </nav>
  </div>

  <!-- Scoreboard Modal (kept simple) -->
  <div id="scoreboard-modal" style="display:none; position:fixed; inset:0; background:rgba(0,0,0,0.88); z-index:2000; align-items:center; justify-content:center;">
    <div style="background:#181818; color:white; border-radius:16px; padding:2rem; max-width:400px; width:90%; text-align:center;">
      <h2 style="font-size:2rem; font-weight:800; margin-bottom:1.2rem;">Info</h2>
      <div id="scoreboard-list"></div>
      <button onclick="closeScoreboardModal()" style="margin-top:1.5rem; padding:10px 32px; font-size:1.1rem; font-weight:700; border:none; border-radius:10px; background:#4ade80; color:#181818; cursor:pointer;">Close</button>
    </div>
  </div>

  <!-- ======= SCRIPT: full game logic ======= -->
  <script>
    /************************************************************************
     * Business Empire Single-File Game
     * - Offline, LocalStorage based
     * - Stocks and Crypto markets with simulated price series
     * - Buy / Sell, Portfolio, P/L, activity log
     *
     * Note: UI styles taken/kept from user's original file.
     ************************************************************************/

    // ---------- Utilities ----------
    const formatMoney = (v) => {
      // show Bengali currency symbol (‡ß≥) with 2 decimals and thousands separators
      const n = Number(v || 0);
      return '‡ß≥ ' + n.toLocaleString(undefined, {minimumFractionDigits:2, maximumFractionDigits:2});
    };

    const nowISO = () => (new Date()).toLocaleString();

    // ---------- Persistent State (localStorage) ----------
    const STORAGE_KEY = 'bizempire_v1';
    let state = {
      balance: 100000.00,
      holdings: {}, // key -> { type: 'stock'|'coin', symbol, name, qty, avgPrice }
      transactions: [], // {time, type: 'buy'|'sell', market:'stock'|'coin', symbol, name, qty, price, total}
      activities: [],
      markets: {
        stocks: {},
        coins: {}
      },
      settings: {
        updateInterval: 60000 // ms (default 1 minute)
      }
    };

    function loadState() {
      try {
        const s = JSON.parse(localStorage.getItem(STORAGE_KEY));
        if (s) {
          state = {...state, ...s};
        }
      } catch(e) {
        console.error('loadState err', e);
      }
    }
    function saveState() {
      localStorage.setItem(STORAGE_KEY, JSON.stringify(state));
    }

    // ---------- Fake market definitions ----------
    const FAKE_COMPANIES = [
      {symbol:'TNVA', name:'TechNova Ltd', base: 120.00},
      {symbol:'SKYO', name:'SkyOil Ltd', base: 86.50},
      {symbol:'GRMT', name:'GreenMart', base: 45.00},
      {symbol:'MEDX', name:'MediX Pharmaceuticals', base: 62.25},
      {symbol:'ROBO', name:'RoboWorks Inc', base: 210.00},
      {symbol:'FOOD', name:'Foodies PLC', base: 31.10},
      {symbol:'ECOA', name:'EcoAutos', base: 155.00},
      {symbol:'EDUT', name:'EduTech Global', base: 27.75}
    ];

    const FAKE_COINS = [
      {symbol:'BTCR', name:'BitCore', base: 32000.00},
      {symbol:'LTDG', name:'LiteDoge', base: 0.35},
      {symbol:'ETHX', name:'EtherX', base: 1800.00},
      {symbol:'SOLR', name:'Solara', base: 45.50},
      {symbol:'MINT', name:'MintCoin', base: 0.12}
    ];

    // initialize market time series
    function seedMarkets() {
      const now = Date.now();
      FAKE_COMPANIES.forEach(c => {
        if (!state.markets.stocks[c.symbol]) {
          // create price history: last 30 points
          const hist = [];
          let p = c.base;
          for (let i=0;i<30;i++){
            // small random walk
            p = +(p * (1 + (Math.random()-0.48)*0.03)).toFixed(4);
            hist.push({t: now - (30-i)*60000, price: p});
          }
          state.markets.stocks[c.symbol] = {symbol:c.symbol, name:c.name, history: hist, current: hist[hist.length-1].price};
        }
      });
      FAKE_COINS.forEach(c => {
        if (!state.markets.coins[c.symbol]) {
          const hist = [];
          let p = c.base;
          for (let i=0;i<30;i++){
            p = +(p * (1 + (Math.random()-0.48)*0.06)).toFixed(8);
            hist.push({t: now - (30-i)*60000, price: p});
          }
          state.markets.coins[c.symbol] = {symbol:c.symbol, name:c.name, history: hist, current: hist[hist.length-1].price};
        }
      });
      saveState();
    }

    // ---------- Price simulation ----------
    let marketInterval = null;
    function startMarketSimulation() {
      stopMarketSimulation();
      const interval = Number(state.settings.updateInterval || 60000);
      marketInterval = setInterval(() => {
        stepMarkets();
      }, interval);
      // run one immediate step for better UX
      stepMarkets();
      // update last-update label
      updateLastUpdateLabels();
    }
    function stopMarketSimulation() {
      if (marketInterval) {
        clearInterval(marketInterval);
        marketInterval = null;
      }
    }
    function stepMarkets() {
      const now = Date.now();
      // Stocks: small moves
      Object.values(state.markets.stocks).forEach(m => {
        const last = m.history[m.history.length-1].price;
        // geometric random walk with small volatility
        const vol = 0.015; // 1.5% typical per tick
        const changeFactor = 1 + (randNormal()*vol);
        let next = +(last * changeFactor);
        if (next <= 0.00001) next = last * 0.99;
        next = roundTo(next, 4);
        m.history.push({t: now, price: next});
        m.current = next;
        if (m.history.length > 200) m.history.shift();
      });
      // Coins: larger moves
      Object.values(state.markets.coins).forEach(m => {
        const last = m.history[m.history.length-1].price;
        const vol = 0.045; // 4.5%
        const changeFactor = 1 + (randNormal()*vol);
        let next = +(last * changeFactor);
        if (next <= 0.0000001) next = last * 0.98;
        next = roundTo(next, 8);
        m.history.push({t: now, price: next});
        m.current = next;
        if (m.history.length > 200) m.history.shift();
      });

      // persist & update UI
      state.activities.unshift({time: nowISO(), type:'market-update', text: 'Market prices updated'});
      if (state.activities.length > 200) state.activities.pop();
      saveState();
      refreshUIAll();
    }

    // helper: normal-ish random (Box-Muller)
    function randNormal() {
      let u = 0, v = 0;
      while(u === 0) u = Math.random();
      while(v === 0) v = Math.random();
      return Math.sqrt(-2.0 * Math.log(u)) * Math.cos(2.0 * Math.PI * v);
    }

    function roundTo(n, digits) {
      const m = Math.pow(10, digits||2);
      return Math.round(n*m)/m;
    }

    // ---------- UI hookup ----------
    function showScreen(name) {
      const screens = ['home','stocks','crypto','portfolio'];
      screens.forEach(s => {
        const el = document.getElementById('screen-'+s);
        if (el) el.classList.toggle('hidden', s !== name);
      });
      // highlight nav
      document.querySelectorAll('.bottom-nav button').forEach(btn => btn.classList.remove('active'));
      // top nav buttons
      document.querySelectorAll('.mode-btn').forEach(b => b.classList.remove('active'));
      // activate corresponding button:
      if (name === 'home') { document.getElementById('nav-home').classList.add('active'); }
      if (name === 'stocks') { document.getElementById('nav-stocks').classList.add('active'); }
      if (name === 'crypto') { document.getElementById('nav-crypto').classList.add('active'); }
      if (name === 'portfolio') { document.getElementById('nav-portfolio').classList.add('active'); }
    }

    // Settings open/close
    function openSettings(){ document.getElementById('settings-panel').style.display='block'; }
    function closeSettings(){ document.getElementById('settings-panel').style.display='none'; }

    function closeScoreboardModal(){ document.getElementById('scoreboard-modal').style.display='none'; }

    // ---------- Market selection & charts ----------
    let selectedStockSymbol = null;
    let marketChart = null;

    let selectedCoinSymbol = null;
    let coinChart = null;

    function buildCompaniesList() {
      const container = document.getElementById('companies-list');
      container.innerHTML = '';
      Object.values(state.markets.stocks).forEach(m => {
        const el = document.createElement('div');
        el.className = 'market-card';
        el.innerHTML = `
          <div style="flex:1">
            <div class="market-name">${m.name}</div>
            <div class="small-muted">${m.symbol}</div>
          </div>
          <div class="text-right">
            <div class="market-price">${formatMoney(m.current)}</div>
            <div class="small-muted">${calcChangeText(m)}</div>
          </div>
        `;
        el.style.cursor = 'pointer';
        el.onclick = () => selectStock(m.symbol);
        container.appendChild(el);
      });
    }

    function buildCoinsList() {
      const container = document.getElementById('coins-list');
      container.innerHTML = '';
      Object.values(state.markets.coins).forEach(m => {
        const el = document.createElement('div');
        el.className = 'market-card';
        el.innerHTML = `
          <div style="flex:1">
            <div class="market-name">${m.name}</div>
            <div class="small-muted">${m.symbol}</div>
          </div>
          <div class="text-right">
            <div class="market-price">${formatMoney(m.current)}</div>
            <div class="small-muted">${calcChangeText(m)}</div>
          </div>
        `;
        el.style.cursor = 'pointer';
        el.onclick = () => selectCoin(m.symbol);
        container.appendChild(el);
      });
    }

    function calcChangeText(m) {
      const hist = m.history;
      if (hist.length < 2) return '‚Äî';
      const prev = hist[hist.length-2].price;
      const cur = m.current;
      const diff = +(cur - prev);
      const pct = +((diff/prev)*100).toFixed(2);
      const sign = diff >= 0 ? '+' : '';
      return `${sign}${pct}% (${formatMoney(diff)})`;
    }

    function selectStock(symbol) {
      selectedStockSymbol = symbol;
      const m = state.markets.stocks[symbol];
      document.getElementById('market-selected-name').innerText = m.name;
      document.getElementById('market-selected-symbol').innerText = m.symbol;
      document.getElementById('market-selected-price').innerText = formatMoney(m.current);
      document.getElementById('market-selected-change').innerText = calcChangeText(m);
      document.getElementById('header-balance').innerText = formatMoney(state.balance);
      // update est cost when qty changes
      document.getElementById('buy-qty').oninput = updateEstCost;
      updateEstCost();
      renderMarketChart(m, 'market-chart');
    }

    function selectCoin(symbol) {
      selectedCoinSymbol = symbol;
      const m = state.markets.coins[symbol];
      document.getElementById('coin-selected-name').innerText = m.name;
      document.getElementById('coin-selected-symbol').innerText = m.symbol;
      document.getElementById('coin-selected-price').innerText = formatMoney(m.current);
      document.getElementById('coin-selected-change').innerText = calcChangeText(m);
      document.getElementById('header-balance-coin').innerText = formatMoney(state.balance);
      document.getElementById('buy-qty-coin').oninput = updateEstCostCoin;
      updateEstCostCoin();
      renderMarketChart(m, 'coin-chart');
    }

    function updateEstCost() {
      const qty = Number(document.getElementById('buy-qty').value || 0);
      if (!selectedStockSymbol) {
        document.getElementById('est-cost').innerText = 'Est. cost: ‡ß≥ 0';
        return;
      }
      const price = state.markets.stocks[selectedStockSymbol].current;
      document.getElementById('est-cost').innerText = 'Est. cost: ' + formatMoney(qty * price);
    }
    function updateEstCostCoin() {
      const qty = Number(document.getElementById('buy-qty-coin').value || 0);
      if (!selectedCoinSymbol) {
        document.getElementById('est-cost-coin').innerText = 'Est. cost: ‡ß≥ 0';
        return;
      }
      const price = state.markets.coins[selectedCoinSymbol].current;
      document.getElementById('est-cost-coin').innerText = 'Est. cost: ' + formatMoney(qty * price);
    }

    function renderMarketChart(market, canvasId) {
      const ctx = document.getElementById(canvasId).getContext('2d');
      const labels = market.history.map(p => (new Date(p.t)).toLocaleTimeString());
      const data = market.history.map(p => p.price);
      const cfg = {
        type: 'line',
        data: {
          labels,
          datasets: [{
            label: market.symbol,
            data,
            fill: true,
            tension: 0.25,
            pointRadius: 0
          }]
        },
        options: {
          animation: false,
          responsive: true,
          plugins: {
            legend: { display: false }
          },
          scales: {
            x: { display: false },
            y: { ticks: { callback: function(val){ return val; } } }
          }
        }
      };
      // destroy existing chart on that canvas
      if (canvasId === 'market-chart') {
        if (marketChart) { try{ marketChart.destroy(); }catch(e){} }
        marketChart = new Chart(ctx, cfg);
      } else {
        if (coinChart) { try{ coinChart.destroy(); }catch(e){} }
        coinChart = new Chart(ctx, cfg);
      }
    }

    // refresh chart data (fast)
    function refreshChartsIfSelected() {
      if (selectedStockSymbol && marketChart) {
        const m = state.markets.stocks[selectedStockSymbol];
        marketChart.data.labels = m.history.map(p => (new Date(p.t)).toLocaleTimeString());
        marketChart.data.datasets[0].data = m.history.map(p => p.price);
        marketChart.update();
        // update price text
        document.getElementById('market-selected-price').innerText = formatMoney(m.current);
        document.getElementById('market-selected-change').innerText = calcChangeText(m);
      }
      if (selectedCoinSymbol && coinChart) {
        const m = state.markets.coins[selectedCoinSymbol];
        coinChart.data.labels = m.history.map(p => (new Date(p.t)).toLocaleTimeString());
        coinChart.data.datasets[0].data = m.history.map(p => p.price);
        coinChart.update();
        document.getElementById('coin-selected-price').innerText = formatMoney(m.current);
        document.getElementById('coin-selected-change').innerText = calcChangeText(m);
      }
    }

    function updateLastUpdateLabels() {
      const t = new Date().toLocaleTimeString();
      document.getElementById('stocks-last-update').innerText = t;
      document.getElementById('crypto-last-update').innerText = t;
    }

    // ---------- Buy / Sell ----------
    function buySelected() {
      if (!selectedStockSymbol) { alert('‡¶ï‡ßã‡¶®‡ßã ‡¶ï‡ßã‡¶Æ‡ßç‡¶™‡¶æ‡¶®‡¶ø ‡¶∏‡¶ø‡¶≤‡ßá‡¶ï‡ßç‡¶ü ‡¶ï‡¶∞‡¶æ ‡¶π‡ßü‡¶®‡¶ø'); return; }
      const qty = Math.floor(Number(document.getElementById('buy-qty').value || 0));
      if (qty <= 0) { alert('‡¶∏‡¶†‡¶ø‡¶ï quantity ‡¶¶‡¶ø‡¶®'); return; }
      const m = state.markets.stocks[selectedStockSymbol];
      const total = roundTo(qty * m.current, 2);
      if (total > state.balance) { alert('‡¶™‡ßç‡¶∞‡¶ö‡ßÅ‡¶∞ ‡¶ü‡¶æ‡¶ï‡¶æ ‡¶®‡ßá‡¶á'); return; }
      state.balance = roundTo(state.balance - total, 2);

      const key = 'stock_'+m.symbol;
      if (!state.holdings[key]) {
        state.holdings[key] = { type:'stock', symbol: m.symbol, name: m.name, qty, avgPrice: m.current };
      } else {
        // update avg price: newAvg = (oldQty*oldAvg + newQty*price)/(oldQty+newQty)
        const h = state.holdings[key];
        const newQty = h.qty + qty;
        const newAvg = ((h.qty * h.avgPrice) + (qty * m.current)) / newQty;
        h.qty = newQty;
        h.avgPrice = roundTo(newAvg, 4);
      }

      const tx = { time: nowISO(), type:'buy', market:'stock', symbol:m.symbol, name:m.name, qty, price:m.current, total };
      state.transactions.unshift(tx);
      state.activities.unshift({ time: nowISO(), type:'buy', text: `Bought ${qty} ${m.symbol} @ ${formatMoney(m.current)} (total ${formatMoney(total)})` });
      if (state.activities.length>200) state.activities.pop();
      saveState();
      refreshUIAll();
      alert('Successfully bought!');
    }

    function buySelectedCoin() {
      if (!selectedCoinSymbol) { alert('‡¶ï‡ßã‡¶®‡ßã coin ‡¶∏‡¶ø‡¶≤‡ßá‡¶ï‡ßç‡¶ü ‡¶ï‡¶∞‡¶æ ‡¶π‡ßü‡¶®‡¶ø'); return; }
      const qty = Number(document.getElementById('buy-qty-coin').value || 0);
      if (qty <= 0) { alert('‡¶∏‡¶†‡¶ø‡¶ï quantity ‡¶¶‡¶ø‡¶®'); return; }
      const m = state.markets.coins[selectedCoinSymbol];
      const total = roundTo(qty * m.current, 2);
      if (total > state.balance) { alert('‡¶™‡ßç‡¶∞‡¶ö‡ßÅ‡¶∞ ‡¶ü‡¶æ‡¶ï‡¶æ ‡¶®‡ßá‡¶á'); return; }
      state.balance = roundTo(state.balance - total, 2);

      const key = 'coin_'+m.symbol;
      if (!state.holdings[key]) {
        state.holdings[key] = { type:'coin', symbol: m.symbol, name: m.name, qty, avgPrice: m.current };
      } else {
        const h = state.holdings[key];
        const newQty = h.qty + qty;
        const newAvg = ((h.qty * h.avgPrice) + (qty * m.current)) / newQty;
        h.qty = newQty;
        h.avgPrice = roundTo(newAvg, 8);
      }

      const tx = { time: nowISO(), type:'buy', market:'coin', symbol:m.symbol, name:m.name, qty, price:m.current, total };
      state.transactions.unshift(tx);
      state.activities.unshift({ time: nowISO(), type:'buy', text: `Bought ${qty} ${m.symbol} @ ${formatMoney(m.current)} (total ${formatMoney(total)})` });
      if (state.activities.length>200) state.activities.pop();
      saveState();
      refreshUIAll();
      alert('Successfully bought!');
    }

    function sellHolding(key) {
      const h = state.holdings[key];
      if (!h) return;
      const marketset = h.type === 'stock' ? state.markets.stocks : state.markets.coins;
      const m = marketset[h.symbol];
      const qtyToSell = prompt(`Sell how many of ${h.symbol}? (You have ${h.qty})`, String(h.qty));
      const qty = Number(qtyToSell);
      if (!qty || qty <= 0) return;
      if (qty > h.qty) { alert('‡¶§‡ßã‡¶Æ‡¶æ‡¶∞ ‡¶ï‡¶æ‡¶õ‡ßá ‡¶™‡¶∞‡ßç‡¶Ø‡¶æ‡¶™‡ßç‡¶§ ‡¶®‡ßá‡¶á'); return; }
      const total = roundTo(qty * m.current, 2);
      // reduce holding
      h.qty = roundTo(h.qty - qty, 8);
      if (h.qty <= 0.00000001) delete state.holdings[key];
      state.balance = roundTo(state.balance + total, 2);
      const tx = { time: nowISO(), type:'sell', market:h.type, symbol:h.symbol, name:h.name, qty, price:m.current, total };
      state.transactions.unshift(tx);
      state.activities.unshift({ time: nowISO(), type:'sell', text: `Sold ${qty} ${h.symbol} @ ${formatMoney(m.current)} (got ${formatMoney(total)})` });
      if (state.activities.length>200) state.activities.pop();
      saveState();
      refreshUIAll();
      alert('Sold successfully!');
    }

    // ---------- UI Refresh / Render ----------
    function refreshUIAll() {
      // header
      document.getElementById('balance').innerText = formatMoney(state.balance);
      document.getElementById('header-balance').innerText = formatMoney(state.balance);
      document.getElementById('header-balance-coin').innerText = formatMoney(state.balance);

      // net worth & total P/L
      const holdingsValue = calcHoldingsValue();
      const networth = roundTo(state.balance + holdingsValue, 2);
      document.getElementById('networth').innerText = formatMoney(networth);

      const totalPL = calcTotalPL();
      const tplEl = document.getElementById('total-pl');
      tplEl.innerText = formatMoney(totalPL);
      tplEl.className = totalPL >= 0 ? 'text-xl font-bold positive' : 'text-xl font-bold negative';

      // activity list
      const al = document.getElementById('activity-list');
      al.innerHTML = '';
      state.activities.slice(0,30).forEach(a=>{
        const d = document.createElement('div');
        d.className = 'notification-item';
        d.style.display='flex';
        d.style.justifyContent='space-between';
        d.innerHTML = `<div><div class="notification-text">${a.text}</div><div class="small-muted">${a.time}</div></div>`;
        al.appendChild(d);
      });

      // companies / coins list
      buildCompaniesList();
      buildCoinsList();

      // portfolio list
      const pl = document.getElementById('portfolio-list');
      pl.innerHTML = '';
      const keys = Object.keys(state.holdings);
      if (keys.length === 0) {
        pl.innerHTML = '<div class="hint">No holdings yet. Buy stocks or crypto to see them here.</div>';
      } else {
        keys.forEach(key=>{
          const h = state.holdings[key];
          const market = h.type === 'stock' ? state.markets.stocks[h.symbol] : state.markets.coins[h.symbol];
          const curPrice = market ? market.current : h.avgPrice;
          const marketVal = roundTo(curPrice * h.qty, 2);
          const plDelta = roundTo((curPrice - h.avgPrice) * h.qty, 2);
          const item = document.createElement('div');
          item.className = 'portfolio-item';
          item.innerHTML = `
            <div style="flex:1">
              <div style="display:flex;align-items:center;gap:8px">
                <div class="pill">${h.symbol}</div>
                <div>
                  <div style="font-weight:800">${h.name}</div>
                  <div class="small-muted">Qty: ${h.qty} ‚Ä¢ Avg: ${formatMoney(h.avgPrice)}</div>
                </div>
              </div>
            </div>
            <div style="text-align:right">
              <div style="font-weight:800">${formatMoney(marketVal)}</div>
              <div class="${plDelta>=0? 'positive': 'negative'}">${plDelta>=0? '+':''}${formatMoney(plDelta)}</div>
              <div class="mt-2" style="display:flex;gap:6px;justify-content:flex-end">
                <button class="btn-small" onclick="selectFromPortfolio('${key}')">Open</button>
                <button class="btn-small btn-danger" onclick="sellHolding('${key}')">Sell</button>
              </div>
            </div>
          `;
          pl.appendChild(item);
        });
      }

      // transactions list
      const txEl = document.getElementById('transactions-list');
      txEl.innerHTML = '';
      if (state.transactions.length === 0) {
        txEl.innerHTML = '<div class="hint">No transactions yet.</div>';
      } else {
        state.transactions.slice(0,80).forEach(tx=>{
          const el = document.createElement('div');
          el.className = 'notification-item';
          el.innerHTML = `<div style="flex:1"><div style="font-weight:800">${tx.type.toUpperCase()} ${tx.symbol} x ${tx.qty}</div><div class="small-muted">${tx.time}</div></div><div style="text-align:right">${formatMoney(tx.total)}</div>`;
          txEl.appendChild(el);
        });
      }

      // refresh charts
      refreshChartsIfSelected();
      updateLastUpdateLabels();
    }

    function selectFromPortfolio(key) {
      const h = state.holdings[key];
      if (!h) return;
      if (h.type === 'stock') {
        selectStock(h.symbol);
        showScreen('stocks');
      } else {
        selectCoin(h.symbol);
        showScreen('crypto');
      }
    }

    function calcHoldingsValue() {
      let sum = 0;
      Object.values(state.holdings).forEach(h=>{
        const market = h.type === 'stock' ? state.markets.stocks[h.symbol] : state.markets.coins[h.symbol];
        const price = market ? market.current : h.avgPrice;
        sum += price * h.qty;
      });
      return roundTo(sum, 2);
    }

    function calcTotalPL() {
      let sum = 0;
      Object.values(state.holdings).forEach(h=>{
        const market = h.type === 'stock' ? state.markets.stocks[h.symbol] : state.markets.coins[h.symbol];
        const price = market ? market.current : h.avgPrice;
        sum += (price - h.avgPrice) * h.qty;
      });
      return roundTo(sum, 2);
    }

    // ---------- Settings actions ----------
    function applySettings() {
      const val = Number(document.getElementById('setting-start-balance').value || 0);
      const speed = Number(document.getElementById('setting-speed').value || 60000);
      if (val < 0) { alert('Balance must be >= 0'); return; }
      state.settings.updateInterval = speed;
      // if starting balance changed, offer to reset
      if (val !== state.balance && confirm('Apply will set your current balance to this value (does not change holdings). Continue?')) {
        state.balance = roundTo(val,2);
      }
      saveState();
      startMarketSimulation();
      refreshUIAll();
      alert('Settings applied');
    }

    function resetGame() {
      if (!confirm('Reset will clear holdings, transactions and activities. Continue?')) return;
      state.balance = Number(document.getElementById('setting-start-balance').value || 100000);
      state.holdings = {};
      state.transactions = [];
      state.activities = [{time: nowISO(), type:'system', text:'Game reset'}];
      // re-seed markets fresh
      state.markets = {stocks:{}, coins:{}};
      seedMarkets();
      saveState();
      refreshUIAll();
      alert('Game reset done');
    }

    // ---------- Helper UI onload ----------
    function initUI() {
      loadState();
      // if no markets seeded, seed
      if (!state.markets || !state.markets.stocks || Object.keys(state.markets.stocks).length===0) {
        state.markets = {stocks:{}, coins:{}};
        seedMarkets();
      }
      // init UI elements
      document.getElementById('display-username').innerText = 'Player';
      document.getElementById('setting-start-balance').value = Math.round(state.balance);
      document.getElementById('setting-speed').value = state.settings.updateInterval || 60000;

      // wire up nav header buttons (top)
      document.querySelectorAll('.mode-btn').forEach(b=>{
        b.addEventListener('click', () => {
          document.querySelectorAll('.mode-btn').forEach(x=>x.classList.remove('active'));
          b.classList.add('active');
        });
      });

      // initial renders
      buildCompaniesList();
      buildCoinsList();
      refreshUIAll();

      // default select first company for convenience
      const firstStock = Object.keys(state.markets.stocks)[0];
      if (firstStock) selectStock(firstStock);
      const firstCoin = Object.keys(state.markets.coins)[0];
      if (firstCoin) selectCoin(firstCoin);

      // start simulation
      startMarketSimulation();

      // show home by default
      showScreen('home');
    }

    // ---------- small helpers ----------
    function addActivity(text) {
      state.activities.unshift({time: nowISO(), type:'note', text});
      if (state.activities.length>200) state.activities.pop();
      saveState();
    }

    // ---------- initialize when DOM ready ----------
    document.addEventListener('DOMContentLoaded', ()=> {
      try {
        initUI();
      } catch(e) {
        console.error(e);
      }
    });

    // ensure charts update gently on window focus (in case interval paused by browser)
    window.addEventListener('focus', ()=> {
      refreshUIAll();
    });

    // cleanly stop interval on unload
    window.addEventListener('beforeunload', ()=> {
      stopMarketSimulation();
      saveState();
    });

    // expose small functions for buttons
    window.showScreen = showScreen;
    window.openSettings = openSettings;
    window.closeSettings = closeSettings;
    window.applySettings = applySettings;
    window.resetGame = resetGame;
    window.buySelected = buySelected;
    window.buySelectedCoin = buySelectedCoin;
    window.sellHolding = sellHolding;
    window.closeScoreboardModal = closeScoreboardModal;

  </script>
</body>
      </html>
